---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Register - 1li.tw">
  <main class="flex flex-col items-center justify-center flex-grow px-4">
    <div class="w-full max-w-md">
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-3xl font-bold justify-center mb-6">Create Your Account</h2>
          <form id="register-form">
            <div class="form-control">
              <label class="label" for="username">
                <span class="label-text">Username</span>
              </label>
              <input type="text" id="username" name="username" placeholder="choose_a_username" class="input input-bordered" required />
            </div>
            <div class="form-control mt-4">
              <label class="label" for="password">
                <span class="label-text">Password</span>
              </label>
              <input type="password" id="password" name="password" placeholder="a_strong_password" class="input input-bordered" required />
            </div>
             <div class="form-control mt-4">
              <label class="label" for="confirm_password">
                <span class="label-text">Confirm Password</span>
              </label>
              <input type="password" id="confirm_password" name="confirm_password" placeholder="repeat_the_password" class="input input-bordered" required />
            </div>
            <div class="form-control mt-6">
              <button type="submit" class="btn btn-primary">Create Account</button>
            </div>
          </form>
          <p id="error-message" class="text-error mt-4 text-center"></p>
          <div class="divider">Already have an account?</div>
          <a href="/login" class="btn btn-outline w-full">Login</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    const form = document.getElementById('register-form');
    const errorMessage = document.getElementById('error-message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const username = formData.get('username');
      const password = formData.get('password');
      const confirmPassword = formData.get('confirm_password');
      errorMessage.textContent = '';

      if (password !== confirmPassword) {
        errorMessage.textContent = 'Passwords do not match.';
        return;
      }

      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Registration failed');
        }

        // On success, redirect to the login page
        window.location.href = '/login';

      } catch (err) {
        errorMessage.textContent = err.message;
      }
    });
  </script>
</Layout>
